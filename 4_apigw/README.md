# Exposing Lambda through API Gateway

## Description

In this lab we will learn how to expose our Lambda externally and call it through an API Gateway. We will expand on the example we built in the previous lab reusing much of the Python code and the Terraform to setup the environment

## Project code structure

### [weather_api](weather_api/index.py)

There need to be slight modifications to the script used to interact with OpenWeatherMap. Instead of reading *city_name* directly from an event it will be passed through *queryStringParameters*, which is what API Gateway will use for passing parameters.

The return value needs to be formatted as an HTTP response in order for the client to parse it correctly, including statusCode, headers and the body of the message

### [api_gateway.tf](api_gateway.tf)

Modules related to API Gateway are described in this file. There are a number of different parameters that can be configured in an API Gateway and for this lab we're using the minimum required to get the working example.

We're creating a simple HTTP API that integrates with a Lambda function through a GET request to a /weather endpoint. The requests to the API will be stored in a separate CloudWatch log group. We also need to create a permission to allow our Lambda code to be executed by API Gateway. Finally, we will output the URL of the API gateway that we have created as a value in our Terraform

After deploying the modules we can check the AWS Console Lambda and see that the function is now connected to an API Gateway

![Lambda creation screen](/4_apigw/img/Lambda_API_GW.png)

## Deployment

### Environment setup

As in the previous lab, Terraform will need to know which AWS profile to use when connecting to AWS API. Assuming you have installed your AWS CLI and configured access to your account described in the [setup part](../README.md)

```console
export AWS_PROFILE=<profile_name>
```
### Initialise Terraform providers

Similarly to previous example, we need to run Terraform init in this folder since each project has its own list of dependencies

```console
terraform init
```

### Fill out the config file

Make sure that you fill out the parameters in [prod.tfvars](prod.tfvars) with your values

* maintainer - your name
* weather_api_key - API key from your OpenWeatherMap account
* profile - name of AWS profile you have configured in ~/.aws/credentials

### Apply changes

Deploy the changes to our target environment

```console
terraform apply -var-file prod.tfvars
```

Observe that the randomized URL of the API Gateway route is provided as an output from the apply command

```
Outputs:

api_gw_url = "https://abcdef123.execute-api.eu-west-1.amazonaws.com/Lab4_WeatherAPI_GW/weather?city_name="
```

### Test changes

To test if our function has deployed correctly and is now reachable as an API request, navigate to the URL provided by the Terraform output and add name of the city at the end. If everything is setup correctly, you should be able to see current weather returned as JSON output in your browser

Optionally, check out log messages that are generated by both Lambda and API Gateway in Cloudwatch log groups

### Teardown

After you have ensured that the deployment works, you can clean up the changes you deployed with the following command

    terraform destroy -var-file prod.tfvars
